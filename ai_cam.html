<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera System (Tracking)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Prompt', sans-serif; 
            text-align: center; 
            background: transparent; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        
        #loading { margin-top: 20px; font-weight: bold; color: #00566B; }

        /* ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
        #canvas-container { 
            position: relative; 
            width: 95%;
            max-width: 640px;
            height: auto;
            margin: 10px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background: #000;
        }
        
        video { display: none; }
        canvas { display: block; width: 100%; height: auto; }

        .status-box {
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 30px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #00566B;
            font-size: 1.1rem;
        }
        
        #countDisplay { font-size: 1.5rem; font-weight: bold; color: #E74C3C; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î */
        .btn-group { margin-top: 5px; }
        button { 
            padding: 10px 20px; 
            font-size: 1rem; 
            cursor: pointer; 
            border: none; 
            border-radius: 50px; 
            margin: 5px; 
            color: white; 
            font-weight: bold; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .btn-start { background: #27ae60; }
        .btn-start:hover { background: #219150; }
        .btn-stop { background: #c0392b; }
        .btn-stop:hover { background: #a93226; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* Log */
        .log { 
            height: 60px; 
            width: 90%; 
            overflow-y: scroll; 
            border: 1px solid #ddd; 
            background: rgba(255,255,255,0.8); 
            font-size: 0.8em; 
            text-align: left; 
            padding: 5px;
            margin-top: 5px;
            border-radius: 5px;
        }
        
        /* --- Header & Navbar --- */
        .top-header { background: white; padding: 15px 0; border-bottom: 1px solid #ddd; z-index: 10; width: 100%; }
        .logo-img { height: 60px; width: auto; object-fit: contain; margin-right: 10px; transition: transform 0.2s; }
        .logo-img:hover { transform: scale(1.05); }
        .header-title { color: #b00d23; font-weight: 700; text-transform: uppercase; text-align: center; margin: 0; line-height: 1.2; }
        .header-subtitle { color: #008080; text-align: center; font-size: 0.9rem; margin-top: 5px; }

        .main-navbar { background-color: #b00d23; padding: 15px 0; white-space: nowrap; overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 9; width: 100%; }
        .nav-container { display: flex; justify-content: center; gap: 10px; min-width: max-content; padding: 0 15px; }
        .nav-btn { background: rgba(255,255,255,0.15); color: white !important; border: 1px solid rgba(255,255,255,0.2); border-radius: 50px; padding: 10px 25px; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; }
        .nav-btn:hover, .nav-btn.active { background: white; color: #b00d23 !important; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="top-header">
        <div class="container">
            <div class="row align-items-center" style="display:flex; justify-content:center; flex-wrap:wrap;">
                <div class="col-lg-12 text-center">
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDH91BizHKqi00_QqEcCQ76jrBxJrRGTthfQ&s" class="logo-img" alt="R8">
                        <img src="https://skko.moph.go.th/dward/document_file/skko/common_form_upload_file/20160322201256_410195252.png" class="logo-img" alt="SKKO">
                        <img src="https://swdcph.moph.go.th/intranet/login/images/logo_swd.png" class="logo-img" alt="SWD">
                        <img src="https://mohpromt.moph.go.th/mpc/wp-content/uploads/2021/10/New_logo-mohpormt-01.png" class="logo-img" alt="MorProm" style="height: 55px;">
                    </div>
                    <h2 class="header-title">EVENT QUICK BIG WIN</h2>
                    <p class="header-subtitle">‡∏ö‡∏π‡∏ò‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞ (AI Counter)</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Navbar -->
    <div class="main-navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-btn"><i class="fa-solid fa-chart-line"></i> ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
            <a href="ai_cam.html" class="nav-btn active"><i class="fa-solid fa-video"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ô (AI)</a>
            <a href="lucky_game.html" class="nav-btn"><i class="fa-solid fa-gift"></i> ‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• Big Win</a>
            <a href="hero_scan.html" class="nav-btn"><i class="fa-solid fa-user-check"></i> Digital Hero Scan</a>
        </div>
    </div>

    <div id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI Model... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)</div>
    
    <div id="canvas-container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="status-box">
        ‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="countDisplay">0</span> ‡∏Ñ‡∏ô 
        <small>(‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á)</small>
    </div>

    <div class="btn-group">
        <button id="btnStart" class="btn-start" onclick="startCamera()">üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        <button id="btnStop" class="btn-stop" onclick="stopCamera()" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    </div>

    <div class="log" id="logArea">Log ‡∏£‡∏∞‡∏ö‡∏ö...</div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec"; 
        
        const LINE_POSITION_PERCENT = 0.5; // ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (0.5 = 50%)
        const TRACKING_THRESHOLD = 50; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏° (pixels)
        
        let model;
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let isModelLoaded = false;
        let isStreaming = false; 
        let animationId = null;

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tracking
        let trackedObjects = {}; // ‡πÄ‡∏Å‡πá‡∏ö object { id: {x, y, age} }
        let nextObjectId = 0;
        
        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
        cocoSsd.load().then(loadedModel => {
            model = loadedModel;
            isModelLoaded = true;
            document.getElementById("loading").style.display = 'none'; 
            log("‚úÖ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô!");
        });

        async function startCamera() {
            if (!isModelLoaded) { alert("‡∏£‡∏≠ AI ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
            if (isStreaming) return;

            try {
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á webcam ‡∏õ‡∏Å‡∏ï‡∏¥
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, facingMode: 'environment' },
                    audio: false 
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    isStreaming = true;
                    toggleButtons(true);
                    detectFrame();
                    log("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á (Tracking Mode)");
                };
            } catch (err) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err);
            }
        }

        function stopCamera() {
            if (!isStreaming) return;
            isStreaming = false;
            if (animationId) cancelAnimationFrame(animationId);

            const stream = video.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#000";
            ctx.fillRect(0,0, canvas.width, canvas.height);
            
            toggleButtons(false);
            log("‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
        }

        async function detectFrame() {
            if (!isStreaming) return;

            const predictions = await model.detect(video);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ô (‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á)
            const lineY = canvas.height * LINE_POSITION_PERCENT;
            ctx.beginPath();
            ctx.moveTo(0, lineY);
            ctx.lineTo(canvas.width, lineY);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 3;
            ctx.stroke();

            // --- Tracking Logic ---
            let currentFramePeople = [];

            // 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á (Centroid)
            predictions.forEach(prediction => {
                if (prediction.class === 'person') {
                    const [x, y, width, height] = prediction.bbox;
                    const centerX = x + (width / 2);
                    const centerY = y + (height / 2); // ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏á (‡πÄ‡∏ó‡πâ‡∏≤) ‡∏Å‡πá‡πÑ‡∏î‡πâ
                    currentFramePeople.push({ x: centerX, y: centerY, bbox: prediction.bbox });
                }
            });

            // 2. ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö Tracked Objects ‡πÄ‡∏î‡∏¥‡∏°
            let newTrackedObjects = {};
            
            currentFramePeople.forEach(person => {
                let bestMatchId = null;
                let minDistance = TRACKING_THRESHOLD; // ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏°

                // ‡∏´‡∏≤ ID ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                for (let id in trackedObjects) {
                    let obj = trackedObjects[id];
                    let distance = Math.hypot(person.x - obj.x, person.y - obj.y);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        bestMatchId = id;
                    }
                }

                if (bestMatchId !== null) {
                    // *** ‡πÄ‡∏à‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏° ***
                    let oldY = trackedObjects[bestMatchId].y;
                    let newY = person.y;

                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô List ‡πÉ‡∏´‡∏°‡πà
                    newTrackedObjects[bestMatchId] = { x: person.x, y: person.y, age: 0 };
                    
                    // *** ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô (Logic ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ***
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏à‡∏≤‡∏Å ‡∏ö‡∏ô -> ‡∏•‡πà‡∏≤‡∏á (‡∏Ñ‡πà‡∏≤ Y ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô)
                    if (oldY < lineY && newY >= lineY) {
                        // ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤!
                        sendDataToGAS(1);
                        drawFlash(canvas.width, canvas.height); // Flash ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                    }
                    // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° else if (oldY > lineY && newY <= lineY)

                    // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å trackedObjects ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤ match ‡∏ã‡πâ‡∏≥
                    delete trackedObjects[bestMatchId]; 
                } else {
                    // *** ‡πÄ‡∏à‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà ***
                    newTrackedObjects[nextObjectId++] = { x: person.x, y: person.y, age: 0 };
                }
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Tracking
            trackedObjects = newTrackedObjects;

            // 3. ‡∏ß‡∏≤‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            for (let id in trackedObjects) {
                let obj = trackedObjects[id];
                const [x, y, w, h] = [obj.x - 25, obj.y - 50, 50, 100]; // ‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ
                
                ctx.strokeStyle = "#00FFFF";
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, w, h);
                
                ctx.fillStyle = "lime";
                ctx.fillText(`ID: ${id}`, x, y - 5);
                ctx.beginPath();
                ctx.arc(obj.x, obj.y, 5, 0, 2 * Math.PI);
                ctx.fill();
            }

            animationId = requestAnimationFrame(detectFrame);
        }

        function drawFlash(w, h) {
            ctx.fillStyle = "rgba(0, 255, 0, 0.3)";
            ctx.fillRect(0, 0, w, h);
        }

        function sendDataToGAS(count) {
            let display = document.getElementById("countDisplay");
            display.innerText = parseInt(display.innerText) + count;
            
            // Effect ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πâ‡∏á
            display.style.fontSize = "2.5rem";
            display.style.color = "#27ae60";
            setTimeout(() => {
                display.style.fontSize = "1.5rem";
                display.style.color = "#E74C3C";
            }, 300);

            log("‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô +1");

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏ú‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•)
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ count: count, type: "entry" })
            }).catch(err => {
                log("‚ùå Error ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            });
        }

        function toggleButtons(isRunning) {
            document.getElementById("btnStart").disabled = isRunning;
            document.getElementById("btnStop").disabled = !isRunning;
        }

        function log(msg) {
            const logDiv = document.getElementById("logArea");
            const time = new Date().toLocaleTimeString('th-TH');
            logDiv.innerHTML = `<div>[${time}] ${msg}</div>` + logDiv.innerHTML;
        }
    </script>
</body>
</html>
