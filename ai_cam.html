<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera System</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body { 
            font-family: 'Prompt', sans-serif; 
            text-align: center; 
            background: transparent; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏∑‡∏ô */
            margin: 0; 
            padding: 0; 
            overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar ‡∏Ç‡∏≠‡∏á iframe */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        
        #loading { margin-top: 20px; font-weight: bold; color: #00566B; }

        /* ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
        #canvas-container { 
            position: relative; 
            width: 95%;
            max-width: 640px;
            height: auto;
            margin: 10px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background: #000;
        }
        
        video { display: none; }
        canvas { display: block; width: 100%; height: auto; }

        .status-box {
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 30px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #00566B;
            font-size: 1.1rem;
        }
        
        #countDisplay { font-size: 1.5rem; font-weight: bold; color: #E74C3C; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î */
        .btn-group { margin-top: 5px; }
        button { 
            padding: 10px 20px; 
            font-size: 1rem; 
            cursor: pointer; 
            border: none; 
            border-radius: 50px; 
            margin: 5px; 
            color: white; 
            font-weight: bold; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .btn-start { background: #27ae60; }
        .btn-start:hover { background: #219150; }
        .btn-stop { background: #c0392b; }
        .btn-stop:hover { background: #a93226; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* Log ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        .log { 
            height: 60px; 
            width: 90%; 
            overflow-y: scroll; 
            border: 1px solid #ddd; 
            background: rgba(255,255,255,0.8); 
            font-size: 0.8em; 
            text-align: left; 
            padding: 5px;
            margin-top: 5px;
            border-radius: 5px;
        }
        
         /* --- Header & Navbar --- */
        .top-header { background: white; padding: 15px 0; border-bottom: 1px solid #ddd; z-index: 10; }
        .logo-img { height: 60px; width: auto; object-fit: contain; margin-right: 10px; transition: transform 0.2s; }
        .logo-img:hover { transform: scale(1.05); }
        .header-title { color: #b00d23; font-weight: 700; text-transform: uppercase; text-align: center; margin: 0; line-height: 1.2; }
        .header-subtitle { color: #008080; text-align: center; font-size: 0.9rem; margin-top: 5px; }

        .main-navbar { background-color: #b00d23; padding: 15px 0; white-space: nowrap; overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 9; }
        .nav-container { display: flex; justify-content: center; gap: 10px; min-width: max-content; padding: 0 15px; }
        .nav-btn { background: rgba(255,255,255,0.15); color: white !important; border: 1px solid rgba(255,255,255,0.2); border-radius: 50px; padding: 10px 25px; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; }
        .nav-btn:hover, .nav-btn.active { background: white; color: #b00d23 !important; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* --- Stat Cards --- */
        .stat-card { background: white; border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative; overflow: hidden; height: 100%; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        
        .border-top-teal { border-top: 6px solid #20c997; }
        .border-top-red { border-top: 6px solid #dc3545; }
        .border-top-blue { border-top: 6px solid #0d6efd; }

        .main-icon { font-size: 3.5rem; margin-bottom: 20px; }
        .icon-teal { color: #20c997; }
        .icon-red { color: #dc3545; }
        .icon-blue { color: #0d6efd; }

        .odometer { font-size: 4.5rem; font-weight: 800; color: #333; line-height: 1; }
        .watermark-icon { position: absolute; bottom: -20px; right: 10px; font-size: 10rem; opacity: 0.08; color: #000; z-index: 0; pointer-events: none; transform: rotate(-15deg); }
        .card-content { position: relative; z-index: 2; padding: 40px 20px; text-align: center; }

        /* --- Footer --- */
        .custom-footer { margin-top: auto; background-color: #b00d23; color: white; padding: 30px 0 15px 0; font-size: 0.9rem; }
        .footer-link { color: white; text-decoration: none; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .footer-link:hover { opacity: 0.8; color: #ffd700; }
        .footer-divider { margin: 0 10px; opacity: 0.5; }
        .copyright-text { border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; margin-top: 20px; font-size: 0.8rem; opacity: 0.9; }

        /* --- HERO FOUND POPUP (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡πÉ‡∏´‡∏°‡πà) --- */
        .found-modal {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.95); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        
        .found-icon-container { position: relative; margin-bottom: 20px; }

        /* ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á */
        .found-medal {
            font-size: 12rem;
            color: #ffd700;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
            animation: pulse 1s infinite; /* ‡πÄ‡∏ï‡πâ‡∏ô‡∏ï‡∏∏‡∏ö‡πÜ */
        }

        .found-title {
            color: #ff6b6b;
            font-size: 6rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin: 0;
            text-shadow: 0 0 30px rgba(255, 107, 107, 0.8);
            animation: rubberBand 1s; /* ‡πÄ‡∏î‡πâ‡∏á‡∏î‡∏∂‡πã‡∏á */
        }

        .found-subtitle {
            font-size: 2.5rem;
            color: #20c997;
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 0 0 10px rgba(32, 201, 151, 0.5);
        }
        
        .found-desc {
            color: white;
            font-size: 1.5rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .dismiss-btn {
            margin-top: 40px;
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
        }
        .dismiss-btn:hover { background: white; color: black; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Browser ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) */
        .sound-toggle {
            position: fixed; bottom: 20px; right: 20px; 
            background: rgba(0,0,0,0.5); color: white; 
            border: none; border-radius: 50%; width: 50px; height: 50px;
            z-index: 100; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        </style>
</head>
<body>
    <!-- Header -->
    <header class="top-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 col-md-12 text-center text-lg-start mb-2 mb-lg-0">
                    <div class="d-flex justify-content-center justify-content-lg-start gap-2">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDH91BizHKqi00_QqEcCQ76jrBxJrRGTthfQ&s" class="logo-img" alt="R8">
                        <img src="https://skko.moph.go.th/dward/document_file/skko/common_form_upload_file/20160322201256_410195252.png" class="logo-img" alt="SKKO">
                        <img src="https://swdcph.moph.go.th/intranet/login/images/logo_swd.png" class="logo-img" alt="SWD">
                    </div>
                </div>
                <div class="col-lg-4 col-md-12 text-center mb-2 mb-lg-0">
                    <h2 class="header-title">EVENT QUICK BIG WIN<br><span style="font-size: 0.8em; color:#555;">‡∏´‡∏°‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏° SUPER APP</span></h2>
                    <p class="header-subtitle">‡∏ö‡∏π‡∏ò‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞ ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏¢‡∏∏‡∏û‡∏£‡∏≤‡∏ä‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏î‡∏ô‡∏î‡∏¥‡∏ô <br>24 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568</p>
                </div>
                <div class="col-lg-4 col-md-12 text-center text-lg-end">
                    <img src="https://mohpromt.moph.go.th/mpc/wp-content/uploads/2021/10/New_logo-mohpormt-01.png" class="logo-img" alt="MorProm" style="height: 55px;">
                </div>
            </div>
        </div>
    </header>

    <div id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI Model... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)</div>
    
    <div id="canvas-container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="status-box">
        ‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="countDisplay">0</span> ‡∏Ñ‡∏ô 
        <small>(‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô)</small>
    </div>

    <div class="btn-group">
        <button id="btnStart" class="btn-start" onclick="startCamera()">üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        <button id="btnStop" class="btn-stop" onclick="stopCamera()" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    </div>

    <div class="log" id="logArea">Log ‡∏£‡∏∞‡∏ö‡∏ö...</div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ---
        // ‡πÉ‡∏™‡πà URL Google Apps Script ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec"; 
        
        const LINE_POSITION_PERCENT = 0.6;
        const COOLDOWN_TIME = 2000;
        
        let model;
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let lastSentTime = 0;
        let isModelLoaded = false;
        let isStreaming = false; 
        let animationId = null;

        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
        cocoSsd.load().then(loadedModel => {
            model = loadedModel;
            isModelLoaded = true;
            document.getElementById("loading").style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î
            log("‚úÖ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô!");
        });

        async function startCamera() {
            if (!isModelLoaded) { alert("‡∏£‡∏≠ AI ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
            if (isStreaming) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    isStreaming = true;
                    toggleButtons(true);
                    detectFrame();
                    log("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á");
                };
            } catch (err) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err);
            }
        }

        function stopCamera() {
            if (!isStreaming) return;
            isStreaming = false;
            if (animationId) cancelAnimationFrame(animationId);

            const stream = video.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#000";
            ctx.fillRect(0,0, canvas.width, canvas.height);
            
            toggleButtons(false);
            log("‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
        }

        async function detectFrame() {
            if (!isStreaming) return;

            const predictions = await model.detect(video);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á
            const lineY = canvas.height * LINE_POSITION_PERCENT;
            ctx.beginPath();
            ctx.moveTo(0, lineY);
            ctx.lineTo(canvas.width, lineY);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 3;
            ctx.stroke();

            predictions.forEach(prediction => {
                if (prediction.class === 'person') {
                    const [x, y, width, height] = prediction.bbox;
                    const centerY = y + (height / 2);

                    ctx.strokeStyle = "#00FFFF";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, width, height);

                    if (Math.abs(centerY - lineY) < 30) {
                        ctx.strokeStyle = "lime";
                        ctx.strokeRect(x, y, width, height);
                        
                        const now = Date.now();
                        if (now - lastSentTime > COOLDOWN_TIME) {
                            sendDataToGAS(1);
                            lastSentTime = now;
                        }
                    }
                }
            });
            animationId = requestAnimationFrame(detectFrame);
        }

        function sendDataToGAS(count) {
            let display = document.getElementById("countDisplay");
            display.innerText = parseInt(display.innerText) + count;
            
            // Effect ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πâ‡∏á
            display.style.fontSize = "2rem";
            setTimeout(() => display.style.fontSize = "1.5rem", 200);

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ count: count, type: "entry" })
            }).then(() => {
                log("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• +1 ‡∏Ñ‡∏ô");
            }).catch(err => {
                log("‚ùå Error");
            });
        }

        function toggleButtons(isRunning) {
            document.getElementById("btnStart").disabled = isRunning;
            document.getElementById("btnStop").disabled = !isRunning;
        }

        function log(msg) {
            const logDiv = document.getElementById("logArea");
            logDiv.innerHTML = `<div>${msg}</div>` + logDiv.innerHTML;
        }
    </script>
</body>
</html>
