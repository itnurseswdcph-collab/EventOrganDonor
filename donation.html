<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนบริจาค - Hero Registration</title>
    
    <!-- Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f4f6f9; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Header Stats */
        .top-header { background: white; padding: 20px 0; border-bottom: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card { background: white; border-radius: 15px; padding: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 10px; border: 1px solid #eee; }
        .stat-num { font-size: 2.5rem; font-weight: 800; color: #b00d23; line-height: 1; margin-top: 5px; }
        .stat-label { font-size: 0.9rem; color: #666; }
        
        /* Main Button */
        .main-action-area { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .main-btn {
            background: linear-gradient(135deg, #b00d23 0%, #d63031 100%);
            color: white; border: none; border-radius: 25px; padding: 40px 20px; width: 100%; max-width: 400px;
            font-size: 1.6rem; font-weight: bold; box-shadow: 0 15px 30px rgba(176, 13, 35, 0.3);
            transition: transform 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .main-btn:active { transform: scale(0.95); }
        .main-btn i { font-size: 4rem; }

        /* Modal Steps */
        .modal-content { border-radius: 20px; border: none; overflow: hidden; }
        .modal-header { background: #b00d23; color: white; border: none; }
        .step-container { display: none; text-align: center; padding: 20px; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        
        /* Step 1: Type Selection */
        .type-btn {
            width: 100%; padding: 15px; margin: 8px 0; border: 2px solid #eee; border-radius: 15px;
            background: white; color: #333; font-weight: 600; font-size: 1.2rem; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .type-btn.selected { border-color: #b00d23; background: #fff5f5; color: #b00d23; }
        
        /* Step 2: Camera */
        #camera-area { position: relative; width: 100%; max-width: 320px; margin: 0 auto; overflow: hidden; border-radius: 15px; background: #000; }
        #camera-preview { width: 100%; height: 240px; object-fit: cover; display: block; }
        #captured-image { width: 100%; max-width: 320px; height: auto; border-radius: 10px; display: none; margin: 0 auto; border: 2px solid #b00d23; }
        
        .photo-actions { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- 1. Header แสดงยอดปัจจุบัน -->
    <div class="top-header">
        <div class="container">
            <h5 class="text-center fw-bold mb-3 text-secondary"><i class="fa-solid fa-chart-simple"></i> ยอดผู้บริจาควันนี้</h5>
            <div class="row g-2">
                <div class="col-6">
                    <div class="stat-card">
                        <i class="fa-solid fa-heart-pulse text-danger fs-3"></i>
                        <div class="stat-num" id="stat-organ">...</div>
                        <div class="stat-label">บริจาคอวัยวะ</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card">
                        <i class="fa-solid fa-eye text-primary fs-3"></i>
                        <div class="stat-num" id="stat-eye">...</div>
                        <div class="stat-label">บริจาคดวงตา</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ปุ่มหลักขนาดใหญ่ -->
    <div class="main-action-area">
        <button class="main-btn" onclick="openRegisterModal()">
            <i class="fa-solid fa-user-plus"></i>
            <div>
                <div>เพิ่มผู้บริจาครายใหม่</div>
                <small style="font-size: 1rem; opacity: 0.8; font-weight: normal;">(Register New Hero)</small>
            </div>
        </button>
    </div>
    
    <div class="text-center pb-4">
        <a href="index.html" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fa-solid fa-arrow-left"></i> กลับหน้า Dashboard
        </a>
    </div>

    <!-- 3. Modal ขั้นตอนการลงทะเบียน -->
    <div class="modal fade" id="regModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-clipboard-user"></i> ลงทะเบียนฮีโร่</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    
                    <!-- Step 1: เลือกประเภทการบริจาค -->
                    <div id="step1" class="step-container active">
                        <h5 class="mb-4 text-secondary">ผู้บริจาคแจ้งความจำนงเรื่องใดบ้าง?</h5>
                        
                        <button class="type-btn" onclick="toggleType(this, 'organ')">
                            <i class="fa-solid fa-heart-pulse text-danger"></i> บริจาคอวัยวะ
                        </button>
                        
                        <button class="type-btn" onclick="toggleType(this, 'eye')">
                            <i class="fa-solid fa-eye text-primary"></i> บริจาคดวงตา
                        </button>
                        
                        <div class="mt-4 pt-2">
                            <button class="btn btn-dark w-100 rounded-pill py-2 fs-5" onclick="toStep2()">
                                ถัดไป <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: ถ่ายรูป (Optional) -->
                    <div id="step2" class="step-container">
                        <h5 class="mb-3 text-secondary">ถ่ายรูปขึ้นจอ Dashboard ไหม?</h5>
                        
                        <!-- พื้นที่กล้อง -->
                        <div id="camera-area" style="display:none;">
                            <video id="camera-preview" autoplay playsinline muted></video>
                            <canvas id="canvas" style="display:none;"></canvas> <!-- Canvas ซ่อนไว้ใช้ย่อรูป -->
                            <div class="text-center mt-2 text-white bg-dark rounded-pill py-1 small mx-auto" style="width:150px;">
                                จัดภาพให้อยู่กึ่งกลาง
                            </div>
                        </div>
                        
                        <!-- พื้นที่โชว์รูปที่ถ่ายแล้ว -->
                        <img id="captured-image">

                        <div class="photo-actions">
                            <!-- 1. ปุ่มเปิดกล้อง -->
                            <button id="btn-camera" class="btn btn-outline-danger rounded-pill px-4" onclick="startCamera()">
                                <i class="fa-solid fa-camera"></i> เปิดกล้อง
                            </button>
                            <!-- 2. ปุ่มกดถ่าย -->
                            <button id="btn-snap" class="btn btn-danger rounded-pill px-4" style="display:none;" onclick="takePhoto()">
                                <i class="fa-solid fa-camera-retro"></i> แชะ!
                            </button>
                            <!-- 3. ปุ่มถ่ายใหม่ -->
                            <button id="btn-retake" class="btn btn-secondary rounded-pill px-4" style="display:none;" onclick="retakePhoto()">
                                <i class="fa-solid fa-rotate-left"></i> ถ่ายใหม่
                            </button>
                        </div>

                        <hr class="my-4">

                        <button class="btn btn-success w-100 rounded-pill py-3 fw-bold fs-5 shadow-sm" onclick="submitData()">
                            <i class="fa-solid fa-save"></i> บันทึกข้อมูล
                        </button>
                        <button class="btn btn-link text-muted mt-2 text-decoration-none" onclick="skipPhoto()">
                            ข้าม (ไม่ถ่ายรูป)
                        </button>
                    </div>

                    <!-- Step 3: Loading & Success -->
                    <div id="step3" class="step-container">
                        <div id="loading-spin">
                            <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                            <h5 class="animate__animated animate__pulse animate__infinite">กำลังส่งข้อมูลขึ้นระบบ...</h5>
                        </div>
                        <div id="success-msg" style="display:none;">
                            <i class="fa-solid fa-circle-check text-success animate__animated animate__bounceIn" style="font-size: 5rem;"></i>
                            <h3 class="fw-bold mt-3 text-success">บันทึกสำเร็จ!</h3>
                            <p class="text-muted">ข้อมูลถูกส่งไปที่ Dashboard เรียบร้อยแล้ว</p>
                            <button class="btn btn-primary rounded-pill px-5 mt-3" data-bs-dismiss="modal" onclick="location.reload()">
                                ปิดหน้าต่าง
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // *** URL API ของ Google Apps Script ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec';

        let selectedTypes = { organ: false, eye: false };
        let photoData = null; // เก็บ Base64 ของรูป
        let stream = null;    // เก็บ Stream กล้อง

        // 1. โหลดข้อมูลยอดบริจาคเมื่อเปิดหน้า
        fetch(API_URL)
            .then(r => r.json())
            .then(d => {
                document.getElementById('stat-organ').innerText = d.organ || 0;
                document.getElementById('stat-eye').innerText = d.eye || 0;
            })
            .catch(e => console.log("Load stats error"));

        // 2. เปิด Modal ลงทะเบียน
        function openRegisterModal() {
            // Reset ค่าต่างๆ
            selectedTypes = { organ: false, eye: false };
            photoData = null;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
            
            // ปิดกล้องถ้าเปิดค้างไว้
            stopStream();
            document.getElementById('camera-area').style.display = 'none';
            document.getElementById('captured-image').style.display = 'none';
            document.getElementById('btn-camera').style.display = 'inline-block';
            document.getElementById('btn-snap').style.display = 'none';
            document.getElementById('btn-retake').style.display = 'none';

            switchStep('step1');
            new bootstrap.Modal(document.getElementById('regModal')).show();
        }

        // Logic เลือกประเภท
        function toggleType(btn, type) {
            selectedTypes[type] = !selectedTypes[type];
            if(selectedTypes[type]) btn.classList.add('selected');
            else btn.classList.remove('selected');
        }

        function toStep2() {
            if(!selectedTypes.organ && !selectedTypes.eye) {
                alert("กรุณาเลือกอย่างน้อย 1 รายการครับ");
                return;
            }
            switchStep('step2');
        }

        // --- Camera Functions ---
        async function startCamera() {
            document.getElementById('camera-area').style.display = 'block';
            document.getElementById('captured-image').style.display = 'none';
            document.getElementById('btn-camera').style.display = 'none';
            document.getElementById('btn-snap').style.display = 'inline-block';
            document.getElementById('btn-retake').style.display = 'none';
            
            try {
                // facingMode: 'environment' คือกล้องหลัง (ถ้ามี)
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('camera-preview').srcObject = stream;
            } catch(e) {
                alert("ไม่สามารถเปิดกล้องได้: " + e.message);
                document.getElementById('camera-area').style.display = 'none';
                document.getElementById('btn-camera').style.display = 'inline-block';
            }
        }

        function takePhoto() {
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('canvas');
            
            // กำหนดขนาดรูป (ย่อลงเพื่อส่งเร็วขึ้น)
            const width = 320;
            const height = video.videoHeight / (video.videoWidth/width);
            
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(video, 0, 0, width, height);
            
            // แปลงเป็น Base64 (JPEG quality 0.6)
            photoData = canvas.toDataURL('image/jpeg', 0.6);
            
            // แสดงรูปที่ถ่าย
            const img = document.getElementById('captured-image');
            img.src = photoData;
            img.style.display = 'block';
            document.getElementById('camera-area').style.display = 'none';
            
            // หยุดกล้อง
            stopStream();
            
            // ปรับปุ่ม
            document.getElementById('btn-snap').style.display = 'none';
            document.getElementById('btn-retake').style.display = 'inline-block';
        }

        function retakePhoto() {
            photoData = null;
            startCamera();
        }

        function stopStream() {
            if(stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
        }

        function skipPhoto() {
            photoData = null;
            submitData();
        }

        // --- Submit Logic ---
        function submitData() {
            switchStep('step3');
            document.getElementById('loading-spin').style.display = 'block';
            document.getElementById('success-msg').style.display = 'none';

            // เตรียมรายการที่จะส่ง
            let tasks = [];
            if(selectedTypes.organ) tasks.push('organ');
            if(selectedTypes.eye) tasks.push('eye');

            // ส่งข้อมูลทีละรายการ (Sequential) เพื่อความชัวร์
            let promiseChain = Promise.resolve();

            tasks.forEach((type, index) => {
                promiseChain = promiseChain.then(() => {
                    let payload = { type: type, count: 1 };
                    
                    // ส่งรูปภาพไปกับ request แรกอันเดียวพอ (จะได้ไม่เปลือง bandwidth)
                    if(index === 0 && photoData) {
                        // ตัด header 'data:image/jpeg;base64,' ออก ส่งแค่เนื้อ base64
                        payload.image = photoData.split(',')[1]; 
                    }
                    
                    return fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors', // สำคัญสำหรับ Google Apps Script Web App
                        headers: {'Content-Type': 'text/plain'},
                        body: JSON.stringify(payload)
                    });
                }).then(() => {
                    // Delay นิดหน่อยระหว่าง request เพื่อป้องกัน Google Script ชนกัน
                    return new Promise(resolve => setTimeout(resolve, 800));
                });
            });

            promiseChain.then(() => {
                document.getElementById('loading-spin').style.display = 'none';
                document.getElementById('success-msg').style.display = 'block';
                
                // อัปเดตตัวเลขหน้าเว็บทันที (Feedback ให้ user เห็น)
                if(selectedTypes.organ) {
                    let el = document.getElementById('stat-organ');
                    el.innerText = parseInt(el.innerText || 0) + 1;
                }
                if(selectedTypes.eye) {
                    let el = document.getElementById('stat-eye');
                    el.innerText = parseInt(el.innerText || 0) + 1;
                }
            }).catch(e => {
                alert("เกิดข้อผิดพลาดในการส่งข้อมูล: " + e);
                location.reload();
            });
        }

        function switchStep(id) {
            document.querySelectorAll('.step-container').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
