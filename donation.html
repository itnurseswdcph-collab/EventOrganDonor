<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนบริจาค - Hero Registration</title>
    
    <!-- Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f4f6f9; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Header Stats */
        .top-header { background: white; padding: 20px 0; border-bottom: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card { background: white; border-radius: 15px; padding: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 10px; border: 1px solid #eee; }
        .stat-num { font-size: 2.5rem; font-weight: 800; color: #b00d23; line-height: 1; margin-top: 5px; }
        .stat-label { font-size: 0.9rem; color: #666; }
        
        /* Main Button */
        .main-action-area { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .main-btn {
            background: linear-gradient(135deg, #b00d23 0%, #d63031 100%);
            color: white; border: none; border-radius: 25px; padding: 40px 20px; width: 100%; max-width: 400px;
            font-size: 1.6rem; font-weight: bold; box-shadow: 0 15px 30px rgba(176, 13, 35, 0.3);
            transition: transform 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .main-btn:active { transform: scale(0.95); }
        .main-btn i { font-size: 4rem; }

        /* Modal Steps */
        .modal-content { border-radius: 20px; border: none; overflow: hidden; }
        .modal-header { background: #b00d23; color: white; border: none; }
        .step-container { display: none; text-align: center; padding: 20px; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }
        
        /* Inputs */
        .form-control-lg { border-radius: 15px; background: #f8f9fa; border: 2px solid #eee; }
        .form-control-lg:focus { border-color: #b00d23; box-shadow: none; background: #fff; }

        /* Type Selection */
        .type-btn {
            width: 100%; padding: 15px; margin: 8px 0; border: 2px solid #eee; border-radius: 15px;
            background: white; color: #333; font-weight: 600; font-size: 1.2rem; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .type-btn.selected { border-color: #b00d23; background: #fff5f5; color: #b00d23; }
        
        /* Photo Preview */
        #captured-image { width: 100%; max-width: 320px; height: auto; border-radius: 10px; display: none; margin: 0 auto; border: 2px solid #b00d23; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .photo-actions { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        
        /* Full Screen Camera Overlay */
        #fullscreen-camera {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #camera-preview { width: 100%; height: 100%; object-fit: cover; }
        .camera-controls { position: absolute; bottom: 40px; left: 0; width: 100%; display: flex; justify-content: space-around; align-items: center; padding: 0 30px; }
        .camera-guide { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); color: white; padding: 8px 20px; border-radius: 20px; font-size: 1rem; pointer-events: none; }
        .btn-snap { width: 80px; height: 80px; border-radius: 50%; background: #b00d23; border: 4px solid white; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.1s; }
        .btn-snap:active { transform: scale(0.9); }
        .btn-cam-sec { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; backdrop-filter: blur(5px); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- 1. Header -->
    <div class="top-header">
        <div class="container">
            <h5 class="text-center fw-bold mb-3 text-secondary"><i class="fa-solid fa-chart-simple"></i> ยอดผู้บริจาควันนี้</h5>
            <div class="row g-2">
                <div class="col-6">
                    <div class="stat-card">
                        <i class="fa-solid fa-heart-pulse text-danger fs-3"></i>
                        <div class="stat-num" id="stat-organ">...</div>
                        <div class="stat-label">บริจาคอวัยวะ</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card">
                        <i class="fa-solid fa-eye text-primary fs-3"></i>
                        <div class="stat-num" id="stat-eye">...</div>
                        <div class="stat-label">บริจาคดวงตา</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Main Button -->
    <div class="main-action-area">
        <button class="main-btn" onclick="openRegisterModal()">
            <i class="fa-solid fa-user-plus"></i>
            <div>
                <div>เพิ่มผู้บริจาครายใหม่</div>
                <small style="font-size: 1rem; opacity: 0.8; font-weight: normal;">(Register New Hero)</small>
            </div>
        </button>
    </div>
    
    <div class="text-center pb-4">
        <a href="index.html" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fa-solid fa-arrow-left"></i> กลับหน้า Dashboard
        </a>
    </div>

    <!-- 3. Modal -->
    <div class="modal fade" id="regModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-clipboard-user"></i> ลงทะเบียนฮีโร่</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    
                    <!-- Step 1: ข้อมูลผู้บริจาค -->
                    <div id="step1" class="step-container active">
                        <h5 class="mb-4 text-secondary text-start border-bottom pb-2">1. กรอกข้อมูลผู้บริจาค</h5>
                        
                        <div class="mb-3 text-start">
                            <label class="form-label text-muted">ชื่อจริง</label>
                            <input type="text" id="firstName" class="form-control form-control-lg" placeholder="สมชาย">
                        </div>
                        <div class="mb-3 text-start">
                            <label class="form-label text-muted">นามสกุล</label>
                            <input type="text" id="lastName" class="form-control form-control-lg" placeholder="ใจดี">
                        </div>
                        <div class="mb-3 text-start">
                             <label class="form-label text-muted">ข้อความ Banner (เลือกได้)</label>
                             <select id="message" class="form-select form-select-lg">
                                 <option value="HERO FOUND">HERO FOUND</option>
                                 <option value="ขอขอบคุณ">ขอขอบคุณ</option>
                                 <option value="ผู้เสียสละที่ยิ่งใหญ่">ผู้เสียสละที่ยิ่งใหญ่</option>
                             </select>
                        </div>

                        <div class="mt-4 pt-2">
                            <button class="btn btn-dark w-100 rounded-pill py-2 fs-5" onclick="toStep2()">
                                ถัดไป <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: เลือกประเภทการบริจาค -->
                    <div id="step2" class="step-container">
                        <h5 class="mb-4 text-secondary text-start border-bottom pb-2">2. บริจาคอะไรบ้าง?</h5>
                        
                        <button class="type-btn" onclick="toggleType(this, 'organ')">
                            <i class="fa-solid fa-heart-pulse text-danger"></i> บริจาคอวัยวะ
                        </button>
                        
                        <button class="type-btn" onclick="toggleType(this, 'eye')">
                            <i class="fa-solid fa-eye text-primary"></i> บริจาคดวงตา
                        </button>
                        
                        <div class="mt-4 pt-2 row">
                            <div class="col-4">
                                <button class="btn btn-outline-secondary w-100 rounded-pill py-2" onclick="switchStep('step1')">ย้อนกลับ</button>
                            </div>
                            <div class="col-8">
                                <button class="btn btn-dark w-100 rounded-pill py-2 fs-5" onclick="toStep3()">
                                    ถัดไป <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: ถ่ายรูป -->
                    <div id="step3" class="step-container">
                        <h5 class="mb-3 text-secondary">3. ถ่ายรูปขึ้นจอ Dashboard?</h5>
                        
                        <div class="mb-3">
                            <img id="captured-image">
                        </div>

                        <div class="photo-actions">
                            <button id="btn-camera" class="btn btn-outline-danger rounded-pill px-4 py-2 w-100" onclick="startCamera()">
                                <i class="fa-solid fa-camera"></i> เปิดกล้องถ่ายรูป
                            </button>
                            <button id="btn-retake" class="btn btn-secondary rounded-pill px-4" style="display:none;" onclick="startCamera()">
                                <i class="fa-solid fa-rotate-left"></i> ถ่ายใหม่
                            </button>
                        </div>

                        <hr class="my-4">

                        <button class="btn btn-success w-100 rounded-pill py-3 fw-bold fs-5 shadow-sm" onclick="submitData()">
                            <i class="fa-solid fa-save"></i> บันทึกข้อมูล
                        </button>
                        <div class="row mt-2">
                             <div class="col-4">
                                <button class="btn btn-link text-muted text-decoration-none" onclick="switchStep('step2')">ย้อนกลับ</button>
                             </div>
                             <div class="col-8 text-end">
                                <button class="btn btn-link text-muted text-decoration-none" onclick="skipPhoto()">
                                    ข้าม (ไม่ถ่ายรูป)
                                </button>
                             </div>
                        </div>
                    </div>

                    <!-- Step 4: Loading & Success -->
                    <div id="step4" class="step-container">
                        <div id="loading-spin">
                            <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                            <h5 class="animate__animated animate__pulse animate__infinite">กำลังส่งข้อมูลขึ้นระบบ...</h5>
                        </div>
                        <div id="success-msg" style="display:none;">
                            <i class="fa-solid fa-circle-check text-success animate__animated animate__bounceIn" style="font-size: 5rem;"></i>
                            <h3 class="fw-bold mt-3 text-success">บันทึกสำเร็จ!</h3>
                            <p class="text-muted">ข้อมูลถูกส่งไปที่ Dashboard เรียบร้อยแล้ว</p>
                            <button class="btn btn-primary rounded-pill px-5 mt-3" data-bs-dismiss="modal" onclick="location.reload()">
                                ปิดหน้าต่าง
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Full Screen Camera -->
    <div id="fullscreen-camera">
        <video id="camera-preview" autoplay playsinline muted></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="camera-guide">จัดภาพให้อยู่กึ่งกลาง</div>
        <div class="camera-controls">
            <button class="btn-cam-sec" onclick="stopStream()"><i class="fa-solid fa-xmark"></i></button>
            <button class="btn-snap" onclick="takePhoto()"><i class="fa-solid fa-camera fa-2x"></i></button>
            <button class="btn-cam-sec" onclick="switchCamera()"><i class="fa-solid fa-rotate"></i></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // *** URL API ของคุณ (อย่าลืมเปลี่ยนเป็น URL ที่ Deploy ล่าสุด) ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec';

        let selectedTypes = { organ: false, eye: false };
        let photoData = null;
        let stream = null;
        let currentFacingMode = 'environment';

        // Load Initial Stats
        fetch(API_URL)
            .then(r => r.json())
            .then(d => {
                document.getElementById('stat-organ').innerText = d.organ || 0;
                document.getElementById('stat-eye').innerText = d.eye || 0;
            }).catch(e => console.log("Load stats error"));

        function openRegisterModal() {
            selectedTypes = { organ: false, eye: false };
            photoData = null;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('captured-image').style.display = 'none';
            document.getElementById('btn-camera').style.display = 'block';
            document.getElementById('btn-retake').style.display = 'none';

            switchStep('step1');
            new bootstrap.Modal(document.getElementById('regModal')).show();
        }

        function toggleType(btn, type) {
            selectedTypes[type] = !selectedTypes[type];
            if(selectedTypes[type]) btn.classList.add('selected');
            else btn.classList.remove('selected');
        }

        function toStep2() {
            const fname = document.getElementById('firstName').value.trim();
            const lname = document.getElementById('lastName').value.trim();
            if(!fname || !lname) { alert("กรุณากรอกชื่อและนามสกุล"); return; }
            switchStep('step2');
        }

        function toStep3() {
            if(!selectedTypes.organ && !selectedTypes.eye) { alert("กรุณาเลือกอย่างน้อย 1 รายการ"); return; }
            switchStep('step3');
        }

        // --- Camera Logic ---
        async function startCamera() {
            const camOverlay = document.getElementById('fullscreen-camera');
            camOverlay.style.display = 'flex';
            try {
                if (stream) stopStream();
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
                document.getElementById('camera-preview').srcObject = stream;
            } catch(e) { alert("เปิดกล้องไม่ได้: " + e.message); camOverlay.style.display = 'none'; }
        }

        function switchCamera() {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            startCamera();
        }

        function takePhoto() {
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('canvas');
            const width = 480; 
            const height = video.videoHeight / (video.videoWidth/width);
            canvas.width = width; canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            if (currentFacingMode === 'user') { ctx.translate(width, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, 0, 0, width, height);
            
            photoData = canvas.toDataURL('image/jpeg', 0.7);
            stopStream();
            
            const img = document.getElementById('captured-image');
            img.src = photoData; img.style.display = 'block';
            document.getElementById('btn-camera').style.display = 'none';
            document.getElementById('btn-retake').style.display = 'inline-block';
        }

        function stopStream() {
            if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
            document.getElementById('fullscreen-camera').style.display = 'none';
        }

        function skipPhoto() { photoData = null; submitData(); }

        function submitData() {
            switchStep('step4');
            document.getElementById('loading-spin').style.display = 'block';
            document.getElementById('success-msg').style.display = 'none';

            let tasks = [];
            if(selectedTypes.organ) tasks.push('organ');
            if(selectedTypes.eye) tasks.push('eye');

            let promiseChain = Promise.resolve();

            tasks.forEach((type, index) => {
                promiseChain = promiseChain.then(() => {
                    let payload = { 
                        type: type, 
                        count: 1,
                        firstName: document.getElementById('firstName').value.trim(),
                        lastName: document.getElementById('lastName').value.trim(),
                        message: document.getElementById('message').value
                    };
                    
                    if(index === 0 && photoData) {
                        payload.image = photoData.split(',')[1]; 
                    }
                    
                    return fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {'Content-Type': 'text/plain'},
                        body: JSON.stringify(payload)
                    });
                }).then(() => new Promise(resolve => setTimeout(resolve, 800)));
            });

            promiseChain.then(() => {
                document.getElementById('loading-spin').style.display = 'none';
                document.getElementById('success-msg').style.display = 'block';
            }).catch(e => {
                alert("เกิดข้อผิดพลาด: " + e);
                location.reload();
            });
        }

        function switchStep(id) {
            document.querySelectorAll('.step-container').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
