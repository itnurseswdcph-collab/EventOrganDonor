<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Quick Big Win Dashboard</title>

    <!-- 1. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700;900&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- 2. Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- 3. FontAwesome & Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- 4. Odometer CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.7/themes/odometer-theme-default.min.css" />

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f4f6f9;
            overflow-x: hidden; /* ซ่อน Scrollbar แนวนอน */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Header & Navbar --- */
        .top-header { background: white; padding: 15px 0; border-bottom: 1px solid #ddd; z-index: 10; }
        .logo-img { height: 60px; width: auto; object-fit: contain; margin-right: 10px; transition: transform 0.2s; }
        .logo-img:hover { transform: scale(1.05); }
        .header-title { color: #b00d23; font-weight: 700; text-transform: uppercase; text-align: center; margin: 0; line-height: 1.2; }
        .header-subtitle { color: #008080; text-align: center; font-size: 0.9rem; margin-top: 5px; }

        .main-navbar { background-color: #b00d23; padding: 15px 0; white-space: nowrap; overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 9; }
        .nav-container { display: flex; justify-content: center; gap: 10px; min-width: max-content; padding: 0 15px; }
        .nav-btn { background: rgba(255,255,255,0.15); color: white !important; border: 1px solid rgba(255,255,255,0.2); border-radius: 50px; padding: 10px 25px; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; }
        .nav-btn:hover, .nav-btn.active { background: white; color: #b00d23 !important; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* --- Stat Cards --- */
        .stat-card { background: white; border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative; overflow: hidden; height: 100%; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        
        .border-top-teal { border-top: 6px solid #20c997; }
        .border-top-red { border-top: 6px solid #dc3545; }
        .border-top-blue { border-top: 6px solid #0d6efd; }

        .main-icon { font-size: 3.5rem; margin-bottom: 20px; }
        .icon-teal { color: #20c997; }
        .icon-red { color: #dc3545; }
        .icon-blue { color: #0d6efd; }

        .odometer { font-size: 4.5rem; font-weight: 800; color: #333; line-height: 1; }
        .card-content { position: relative; z-index: 2; padding: 40px 20px; text-align: center; }

        /* --- Footer --- */
        .custom-footer { margin-top: auto; background-color: #b00d23; color: white; padding: 30px 0 15px 0; font-size: 0.9rem; }
        .footer-link { color: white; text-decoration: none; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .footer-link:hover { opacity: 0.8; color: #ffd700; }
        .footer-divider { margin: 0 10px; opacity: 0.5; }
        .copyright-text { border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; margin-top: 20px; font-size: 0.8rem; opacity: 0.9; }

        /* --- HERO FOUND POPUP (FULL SCREEN OVERLAY) --- */
        .found-modal {
            display: none; /* ซ่อนไว้ก่อน */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.95); /* พื้นหลังดำทึบแสง */
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        
        .found-icon-container { position: relative; margin-bottom: 20px; width: 100%; display: flex; justify-content: center; }

        /* กรณีไม่มีรูป (ใช้ไอคอน) */
        .found-medal {
            font-size: 12rem;
            color: #ffd700;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
            animation: pulse 1s infinite;
        }

        /* กรณีมีรูปถ่าย */
        .hero-photo {
            max-width: 80%;
            max-height: 60vh; /* สูงไม่เกิน 60% ของจอ */
            border-radius: 20px;
            border: 8px solid #ffd700;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
            object-fit: cover;
            animation: zoomIn 0.5s;
        }

        /* Banner ด้านบน */
        .found-title {
            color: #ff6b6b;
            font-size: 6rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin: 0;
            text-shadow: 0 0 30px rgba(255, 107, 107, 0.8);
            animation: rubberBand 1s;
            font-family: 'Sarabun', sans-serif;
        }

        /* ชื่อด้านล่าง */
        .found-subtitle {
            font-size: 4rem;
            color: #ffffff;
            font-weight: bold;
            margin-top: 20px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
        }
        
        .found-desc {
            color: #ffd700;
            font-size: 2.5rem;
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .dismiss-btn {
            margin-top: 40px;
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
        }
        .dismiss-btn:hover { background: white; color: black; }

        /* ปุ่มเปิดเสียง (ซ่อนไว้มุมขวาล่าง) */
        .sound-toggle {
            position: fixed; bottom: 20px; right: 20px; 
            background: rgba(0,0,0,0.5); color: white; 
            border: none; border-radius: 50%; width: 50px; height: 50px;
            z-index: 100; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="top-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 col-md-12 text-center text-lg-start mb-2 mb-lg-0">
                    <div class="d-flex justify-content-center justify-content-lg-start gap-2">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDH91BizHKqi00_QqEcCQ76jrBxJrRGTthfQ&s" class="logo-img" alt="R8">
                        <img src="https://skko.moph.go.th/dward/document_file/skko/common_form_upload_file/20160322201256_410195252.png" class="logo-img" alt="SKKO">
                        <img src="https://swdcph.moph.go.th/intranet/login/images/logo_swd.png" class="logo-img" alt="SWD">
                    </div>
                </div>
                <div class="col-lg-4 col-md-12 text-center mb-2 mb-lg-0">
                    <h2 class="header-title">EVENT QUICK BIG WIN<br><span style="font-size: 0.8em; color:#555;">หมอพร้อม SUPER APP</span></h2>
                    <p class="header-subtitle">บูธกิจกรรมรณรงค์และรับบริจาคอวัยวะ โรงพยาบาลสมเด็จพระยุพราชสว่างแดนดิน <br>24 ธันวาคม 2568</p>
                </div>
                <div class="col-lg-4 col-md-12 text-center text-lg-end">
                    <img src="https://mohpromt.moph.go.th/mpc/wp-content/uploads/2021/10/New_logo-mohpormt-01.png" class="logo-img" alt="MorProm" style="height: 55px;">
                </div>
            </div>
        </div>
    </header>

    <!-- Navbar -->
    <div class="main-navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-btn active"><i class="fa-solid fa-chart-line"></i> สรุปแดชบอร์ด</a>
            <a href="ai_cam.html" class="nav-btn"><i class="fa-solid fa-video"></i> ระบบนับคน (AI)</a>
            <a href="donation.html" class="nav-btn"><i class="fa-solid fa-hand-holding-heart"></i> ลงทะเบียนบริจาค</a>
            <a href="lucky_game.html" class="nav-btn"><i class="fa-solid fa-gift"></i> ลุ้นรางวัล Big Win</a>
            <a href="hero_scan.html" class="nav-btn"><i class="fa-solid fa-user-check"></i> Digital Hero Scan</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-5 mb-5">
        <!-- Control Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <div class="text-muted fw-bold">
                <i class="fa-regular fa-clock text-danger"></i> อัปเดตล่าสุด: <span id="current-time">--:--:--</span>
                <span id="api-status" class="badge bg-secondary ms-2">Connecting...</span>
            </div>
            <button class="btn btn-outline-danger rounded-pill px-4" onclick="fetchData()">
                <i class="fa-solid fa-rotate-right me-1"></i> รีเฟรชข้อมูล
            </button>
        </div>

        <div class="row g-4">
            <!-- Card 1: ผู้เข้าชม -->
            <div class="col-md-4">
                <div class="stat-card border-top-teal">
                    <i class="fa-solid fa-users watermark-icon"></i>
                    <div class="card-content">
                        <i class="fa-solid fa-users main-icon icon-teal"></i>
                        <div class="d-block mb-2">
                            <div id="visitor-count" class="odometer">0</div>
                        </div>
                        <h5 class="text-secondary">จำนวนผู้เข้าชมบูธ (คน)</h5>
                    </div>
                </div>
            </div>

            <!-- Card 2: บริจาคอวัยวะ -->
            <div class="col-md-4">
                <div class="stat-card border-top-red">
                    <i class="fa-solid fa-heart-pulse watermark-icon"></i>
                    <div class="card-content">
                        <i class="fa-solid fa-heart-pulse main-icon icon-red"></i>
                        <div class="d-block mb-2">
                            <div id="organ-count" class="odometer">0</div>
                        </div>
                        <h5 class="text-secondary">ลงทะเบียนบริจาคอวัยวะ (ราย)</h5>
                    </div>
                </div>
            </div>

            <!-- Card 3: บริจาคดวงตา -->
            <div class="col-md-4">
                <div class="stat-card border-top-blue">
                    <i class="fa-solid fa-eye watermark-icon"></i>
                    <div class="card-content">
                        <i class="fa-solid fa-eye main-icon icon-blue"></i>
                        <div class="d-block mb-2">
                            <div id="eye-count" class="odometer">0</div>
                        </div>
                        <h5 class="text-secondary">ลงทะเบียนบริจาคดวงตา (ราย)</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- POPUP HERO FOUND (หน้าต่างแจ้งเตือนฮีโร่) -->
    <div id="heroFoundModal" class="found-modal animate__animated">
        
        <!-- ส่วนรูปภาพ (แสดงเมื่อมีรูปส่งมา) -->
        <div class="found-icon-container" id="hero-image-wrapper" style="display:none;">
            <img id="hero-image-el" class="hero-photo" src="" alt="Hero Photo">
        </div>
        
        <!-- ส่วนไอคอน (แสดงเมื่อไม่มีรูป) -->
        <div class="found-icon-container" id="hero-icon-wrapper">
            <i class="fa-solid fa-medal found-medal"></i>
        </div>

        <!-- ข้อความ Banner ด้านบน -->
        <h1 class="found-title" id="hero-banner-el">HERO FOUND!</h1>
        
        <!-- ชื่อผู้บริจาค ด้านล่าง (ตัวใหญ่) -->
        <h2 class="found-subtitle" id="hero-name-el">พบฮีโร่ผู้ให้คนใหม่</h2>
        
        <button class="dismiss-btn" onclick="closeFoundModal()">ปิดหน้าต่าง (Close)</button>
    </div>

    <!-- Footer -->
    <footer class="custom-footer text-center">
        <div class="container">
            <div class="row justify-content-center gy-3 mb-3">
                <div class="col-md-auto">
                    <a href="https://swdcph.moph.go.th" target="_blank" class="footer-link">
                        <i class="fa-solid fa-globe fa-lg"></i> https://swdcph.moph.go.th
                    </a>
                </div>
                <div class="col-md-auto d-none d-md-block"><span class="footer-divider">|</span></div>
                
                <div class="col-md-auto">
                    <a href="https://www.facebook.com/swdcph" target="_blank" class="footer-link">
                        <i class="fa-brands fa-facebook fa-lg"></i> โรงพยาบาลสมเด็จพระยุพราชสว่างแดนดิน
                    </a>
                </div>
                <div class="col-md-auto d-none d-md-block"><span class="footer-divider">|</span></div>

                <div class="col-md-auto">
                    <span class="footer-link">
                        <i class="fa-solid fa-phone fa-lg"></i> 042-721-111
                    </span>
                </div>
            </div>
            <div class="copyright-text">
                &copy; 2025 IT Nurses SWDCPH l Natnainthorn. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Audio Element (เสียง Effect) -->
    <audio id="heroSound" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>

    <!-- ปุ่มเปิดเสียง -->
    <button id="soundToggle" class="sound-toggle" onclick="enableSound()" title="เปิดเสียง">
        <i class="fa-solid fa-volume-xmark" id="soundIcon"></i>
    </button>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.7/odometer.min.js"></script>
    <!-- Library จุดพลุ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        // 1. ตั้งค่า Odometer
        window.odometerOptions = { auto: false, format: '(,ddd)', duration: 2000, theme: 'default' };

        // 2. ลิงก์ Script Google Sheet (URL เดิมของคุณ)
        const API_URL = 'https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec';
        
        // 3. ตัวแปร
        let lastHeroName = ""; // เก็บชื่อคนล่าสุดเพื่อกันซ้ำ
        let isFirstLoad = true;
        let soundEnabled = false;

        // ฟังก์ชันเปิดเสียง (กดปุ่มลำโพงมุมขวาล่าง)
        function enableSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundIcon');
            const sound = document.getElementById('heroSound');
            
            if(soundEnabled) {
                btn.className = 'fa-solid fa-volume-high';
                // เล่นเสียงเบาๆ เพื่อปลดล็อค Browser Autoplay Policy
                sound.volume = 0;
                sound.play().then(() => {
                    sound.pause();
                    sound.volume = 1;
                }).catch(e => console.log("Audio unlock failed"));
            } else {
                btn.className = 'fa-solid fa-volume-xmark';
            }
        }

        // 4. ฟังก์ชันดึงข้อมูล (เพิ่ม Cache Busting ด้วย ?t=...)
        async function fetchData() {
            const statusBadge = document.getElementById('api-status');
            
            try {
                // *** เพิ่ม ?t=... เพื่อแก้ปัญหารูปไม่โหลดทันที (Cache Busting) ***
                const timestamp = new Date().getTime();
                const response = await fetch(API_URL + "?t=" + timestamp);
                
                if (!response.ok) throw new Error('Network error');
                
                const data = await response.json();
                statusBadge.className = 'badge bg-success ms-2';
                statusBadge.innerText = 'Online (Real-time)';

                // อัปเดตตัวเลขหน้าเว็บ
                document.getElementById('visitor-count').innerHTML = data.visitor || 0;
                document.getElementById('organ-count').innerHTML = data.organ || 0;
                document.getElementById('eye-count').innerHTML = data.eye || 0;

                // *** LOGIC ตรวจจับฮีโร่ใหม่ ***
                // ถ้ามีชื่อ Hero ส่งมา และ ไม่ซ้ำกับคนล่าสุดที่เพิ่งโชว์ไป
                if (data.lastHeroName && data.lastHeroName !== lastHeroName) {
                    
                    // อัปเดตชื่อล่าสุด
                    lastHeroName = data.lastHeroName;
                    
                    // เรียกใช้งาน Popup (ข้ามครั้งแรกตอนโหลดหน้าเว็บ เพื่อไม่ให้เด้งใส่หน้าทันที)
                    if (!isFirstLoad) {
                        triggerHeroFound(data);
                    }
                }

                isFirstLoad = false;

            } catch (error) {
                console.error('Error:', error);
                statusBadge.className = 'badge bg-danger ms-2';
                statusBadge.innerText = 'Connection Error';
            }
        }

        // 5. ฟังก์ชันแสดง Popup + พลุ + เสียง
        function triggerHeroFound(data) {
            const modal = document.getElementById('heroFoundModal');
            const sound = document.getElementById('heroSound');
            
            // 5.1 อัปเดตข้อมูลใน Modal
            document.getElementById('hero-banner-el').innerText = data.lastHeroMessage || "HERO FOUND!";
            document.getElementById('hero-name-el').innerText = data.lastHeroName || "พบฮีโร่ใหม่";

            // 5.2 จัดการการแสดงผล รูป vs ไอคอน
            const imgWrapper = document.getElementById('hero-image-wrapper');
            const iconWrapper = document.getElementById('hero-icon-wrapper');
            const imgEl = document.getElementById('hero-image-el');

            if (data.lastHeroImage) {
                // ถ้ามีรูปถ่าย (Base64) ให้โชว์รูป
                imgEl.src = "data:image/jpeg;base64," + data.lastHeroImage;
                imgWrapper.style.display = 'flex';
                iconWrapper.style.display = 'none';
            } else {
                // ถ้าไม่มีรูป ให้โชว์ไอคอนเหรียญ
                imgWrapper.style.display = 'none';
                iconWrapper.style.display = 'flex';
            }

            // 5.3 แสดง Modal และ Effect
            modal.style.display = 'flex';
            modal.classList.add('animate__fadeIn'); 

            // เล่นเสียง (ถ้าเปิดเสียงไว้)
            if (soundEnabled || true) { // บังคับลองเล่นดู
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Autoplay blocked"));
            }

            // จุดพลุ (Confetti)
            const duration = 5000;
            const end = Date.now() + duration;

            (function frame() {
                // พลุซ้าย
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#ffd700', '#ff6b6b', '#ffffff'] 
                });
                // พลุขวา
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#20c997', '#0d6efd', '#ffffff']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());

            // ตั้งเวลาปิดอัตโนมัติ (10 วินาที)
            setTimeout(closeFoundModal, 10000);
        }

        // ฟังก์ชันปิด Popup
        function closeFoundModal() {
            const modal = document.getElementById('heroFoundModal');
            modal.classList.remove('animate__fadeIn');
            modal.classList.add('animate__fadeOut');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.remove('animate__fadeOut');
            }, 500);
        }

        // เริ่มทำงานเมื่อโหลดหน้าเว็บ
        document.addEventListener("DOMContentLoaded", function() {
            // นาฬิกา
            setInterval(() => {
                const now = new Date();
                document.getElementById('current-time').innerText = now.toLocaleTimeString('th-TH');
            }, 1000);

            // Fetch ข้อมูลครั้งแรก
            fetchData(); 
            // Fetch ซ้ำทุก 3 วินาที
            setInterval(fetchData, 3000); 
        });
    </script>
</body>
</html>
