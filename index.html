<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expo People Counter</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding-bottom: 50px; }
        #canvas-container { position: relative; display: inline-block; margin-top: 20px; }
        video { display: none; }
        canvas { border: 2px solid #333; border-radius: 8px; max-width: 100%; background: #000; }
        .status { margin: 10px; font-size: 1.2em; color: #007bff; }
        .log { height: 100px; overflow-y: scroll; border: 1px solid #ccc; background: white; margin: 10px auto; width: 90%; font-size: 0.9em; text-align: left; padding: 5px;}
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
        .btn-group { margin: 15px; }
        button { padding: 12px 25px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; margin: 5px; color: white; font-weight: bold; }
        .btn-start { background: #28a745; }
        .btn-start:hover { background: #218838; }
        .btn-stop { background: #dc3545; }
        .btn-stop:hover { background: #c82333; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <h2>üé• ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏π‡∏ò (AI Counter)</h2>
    <div id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI Model... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)</div>
    
    <div id="canvas-container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="status">
        ‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="countDisplay">0</span> ‡∏Ñ‡∏ô 
        <br><small>(‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô)</small>
    </div>

    <div class="btn-group">
        <button id="btnStart" class="btn-start" onclick="startCamera()">üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        <button id="btnStop" class="btn-stop" onclick="stopCamera()" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    </div>

    <div class="log" id="logArea">Log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>

    <script>
        // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec"; // <--- ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà !!!
        const LINE_POSITION_PERCENT = 0.6;
        const COOLDOWN_TIME = 2000;
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
        let model;
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let lastSentTime = 0;
        let isModelLoaded = false;
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î
        let isStreaming = false; 
        let animationId = null; // ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á Loop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥

        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
        cocoSsd.load().then(loadedModel => {
            model = loadedModel;
            isModelLoaded = true;
            document.getElementById("loading").innerText = "‚úÖ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô!";
            log("AI Loaded success.");
        });

        async function startCamera() {
            if (!isModelLoaded) { alert("‡∏£‡∏≠ AI ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
            if (isStreaming) return; // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î‡∏ã‡πâ‡∏≥

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    isStreaming = true;
                    toggleButtons(true); // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
                    detectFrame(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏π‡∏õ
                    log("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á");
                };
            } catch (err) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err);
            }
        }

        function stopCamera() {
            if (!isStreaming) return;

            // 1. ‡∏´‡∏¢‡∏∏‡∏î Loop ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            isStreaming = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }

            // 2. ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î Hardware ‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÑ‡∏ü‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏î‡∏±‡∏ö)
            const stream = video.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }

            // 3. ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Canvas ‡πÉ‡∏´‡πâ‡∏î‡∏≥
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "black";
            ctx.fillRect(0,0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.fillText("‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß", 20, 50);

            toggleButtons(false); // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏∑‡∏ô
            log("‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
        }

        async function detectFrame() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (!isStreaming) return;

            const predictions = await model.detect(video);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const lineY = canvas.height * LINE_POSITION_PERCENT;
            ctx.beginPath();
            ctx.moveTo(0, lineY);
            ctx.lineTo(canvas.width, lineY);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 4;
            ctx.stroke();

            predictions.forEach(prediction => {
                if (prediction.class === 'person') {
                    const [x, y, width, height] = prediction.bbox;
                    const centerX = x + (width / 2);
                    const centerY = y + (height / 2);

                    ctx.strokeStyle = "#00FFFF";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, width, height);

                    ctx.fillStyle = "yellow";
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
                    ctx.fill();

                    if (Math.abs(centerY - lineY) < 30) {
                        ctx.strokeStyle = "lime";
                        ctx.strokeRect(x, y, width, height);
                        
                        const now = Date.now();
                        if (now - lastSentTime > COOLDOWN_TIME) {
                            sendDataToGAS(1);
                            lastSentTime = now;
                            log("üö∂ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
                        }
                    }
                }
            });

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î
            animationId = requestAnimationFrame(detectFrame);
        }

        function sendDataToGAS(count) {
            let display = document.getElementById("countDisplay");
            display.innerText = parseInt(display.innerText) + count;

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ count: count, type: "entry" })
            }).then(() => {
                log("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            }).catch(err => {
                log("‚ùå Error: " + err);
            });
        }

        function toggleButtons(isRunning) {
            document.getElementById("btnStart").disabled = isRunning;
            document.getElementById("btnStop").disabled = !isRunning;
        }

        function log(msg) {
            const logDiv = document.getElementById("logArea");
            logDiv.innerHTML += `<div>${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>
