<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expo People Counter</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
        #canvas-container { position: relative; display: inline-block; margin-top: 20px; }
        video { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ß‡∏≤‡∏î‡∏•‡∏á Canvas ‡πÅ‡∏ó‡∏ô */
        canvas { border: 2px solid #333; border-radius: 8px; max-width: 100%; }
        .status { margin: 10px; font-size: 1.2em; color: #007bff; }
        .log { height: 100px; overflow-y: scroll; border: 1px solid #ccc; background: white; margin: 10px auto; width: 90%; font-size: 0.9em; text-align: left; padding: 5px;}
        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 5px;}
    </style>
</head>
<body>

    <h2>üé• ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏π‡∏ò (AI Counter)</h2>
    <div id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î AI Model... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)</div>
    
    <div id="canvas-container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="status">
        ‡∏ô‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="countDisplay">0</span> ‡∏Ñ‡∏ô 
        <br><small>(‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô)</small>
    </div>

    <button onclick="startCamera()">üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    <div class="log" id="logArea">Log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>

    <script>
        // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyjbm3yoBaly8pVeXKz1QTpieUe_KjjNWpatAgq_mx3jtkX7zs6vFKm8DXzBCkxNrJm/exec"; // <--- ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà !!!
        const LINE_POSITION_PERCENT = 0.6; // ‡πÄ‡∏™‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 60% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≠ (‡∏Ñ‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á)
        const COOLDOWN_TIME = 2000; // ‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
        let model;
        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let lastSentTime = 0;
        let isModelLoaded = false;

        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
        cocoSsd.load().then(loadedModel => {
            model = loadedModel;
            isModelLoaded = true;
            document.getElementById("loading").innerText = "‚úÖ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô! ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢";
            log("AI Loaded success.");
        });

        async function startCamera() {
            if (!isModelLoaded) { alert("‡∏£‡∏≠ AI ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
            
            // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
                audio: false 
            });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                video.play();
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                detectFrame(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏π‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö
            };
        }

        async function detectFrame() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
            const predictions = await model.detect(video);
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô Line Crossing (‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á)
            const lineY = canvas.height * LINE_POSITION_PERCENT;
            ctx.beginPath();
            ctx.moveTo(0, lineY);
            ctx.lineTo(canvas.width, lineY);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 4;
            ctx.stroke();

            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            let peopleCount = 0;
            let crossCount = 0;

            predictions.forEach(prediction => {
                if (prediction.class === 'person') {
                    peopleCount++;
                    
                    // ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
                    const [x, y, width, height] = prediction.bbox;
                    const centerX = x + (width / 2);
                    const centerY = y + (height / 2);
                    const bottomY = y + height; // ‡∏à‡∏∏‡∏î‡πÄ‡∏ó‡πâ‡∏≤

                    // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏Ñ‡∏ô
                    ctx.strokeStyle = "#00FFFF";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, width, height);

                    // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
                    ctx.fillStyle = "yellow";
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
                    ctx.fill();

                    // --- LOGIC ‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ (Trigger Zone) ---
                    // ‡∏ñ‡πâ‡∏≤‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏ó‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏û‡∏≠‡∏î‡∏µ (‡∏ö‡∏ß‡∏Å‡∏•‡∏ö 20px)
                    if (Math.abs(centerY - lineY) < 30) {
                        ctx.strokeStyle = "lime"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡πÄ‡∏™‡πâ‡∏ô
                        ctx.strokeRect(x, y, width, height);
                        
                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡∏£‡∏±‡∏ß‡πÜ (Cooldown)
                        const now = Date.now();
                        if (now - lastSentTime > COOLDOWN_TIME) {
                            sendDataToGAS(1); // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ 1 ‡∏Ñ‡∏ô
                            lastSentTime = now;
                            log("üö∂ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
                        }
                    }
                }
            });

            requestAnimationFrame(detectFrame); // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥
        }

        function sendDataToGAS(count) {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            let display = document.getElementById("countDisplay");
            display.innerText = parseInt(display.innerText) + count;

            // ‡∏™‡πà‡∏á‡πÑ‡∏õ GAS ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ (no-cors)
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ count: count, type: "entry" })
            }).then(() => {
                log("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + new Date().toLocaleTimeString());
            }).catch(err => {
                log("‚ùå Error: " + err);
            });
        }

        function log(msg) {
            const logDiv = document.getElementById("logArea");
            logDiv.innerHTML += `<div>${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>